# =============================================================================
# Fiutami STAGE Stack - 91.99.229.111 (LEXe)
# =============================================================================
# Deploy: docker compose -p fiutami-stage -f docker-compose.stage.yml up -d <service>
# Frontend: https://stage.fiutami.pet (port 8082)
# Backend:  https://api.stage.fiutami.pet (port 5001)
# Backoffice: https://bo.stage.fiutami.pet (port 8055)
# DB: internal only
#
# IMAGE_TAG: Use environment variable to specify exact image version
# Example: IMAGE_TAG=sha-abc123 docker compose -p fiutami-stage up -d frontend
# =============================================================================

services:
  frontend:
    image: ghcr.io/fiutami/frontend:${IMAGE_TAG:-stage}
    container_name: fiutami-frontend-stage
    restart: unless-stopped
    ports:
      - "8082:80"
    networks:
      - fiutami-stage
      - proxy-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  backend:
    image: ghcr.io/fiutami/backend:${IMAGE_TAG:-stage}
    container_name: fiutami-backend-stage
    restart: unless-stopped
    ports:
      - "5001:5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Staging
      - ASPNETCORE_URLS=http://+:5000
      - ConnectionStrings__DefaultConnection=Server=fiutami-db-stage;Database=fiutami_stage;User=sa;Password=${DB_PASSWORD};TrustServerCertificate=True
      - Jwt__SecretKey=${JWT_SECRET}
      - Jwt__Issuer=Fiutami
      - Jwt__Audience=FiutamiApp
      - Jwt__AccessTokenExpirationMinutes=15
      - Jwt__RefreshTokenExpirationDays=7
      - OAuth__Google__ClientId=${GOOGLE_CLIENT_ID:-}
      - OAuth__Facebook__AppId=${FACEBOOK_APP_ID:-}
      - OAuth__Facebook__AppSecret=${FACEBOOK_APP_SECRET:-}
      - Security__RateLimiting__PermitLimit=5
      - Security__RateLimiting__WindowSeconds=60
    depends_on:
      db:
        condition: service_healthy
    networks:
      - fiutami-stage
      - proxy-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: fiutami-db-stage
    restart: unless-stopped
    # NO port exposed externally for security
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${DB_PASSWORD}
      - MSSQL_PID=Express
    volumes:
      - mssql-stage-data:/var/opt/mssql
    networks:
      - fiutami-stage
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$${MSSQL_SA_PASSWORD}" -C -Q "SELECT 1" || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  backoffice:
    image: ghcr.io/fiutami/backoffice:${IMAGE_TAG:-stage}
    container_name: fiutami-backoffice-stage
    restart: unless-stopped
    ports:
      - "8055:8055"
    environment:
      - DB_CLIENT=mssql
      - DB_HOST=fiutami-db-stage
      - DB_PORT=1433
      - DB_DATABASE=fiutami_stage
      - DB_USER=sa
      - DB_PASSWORD=${DB_PASSWORD}
      - KEY=${DIRECTUS_KEY}
      - SECRET=${DIRECTUS_SECRET}
      - ADMIN_EMAIL=${DIRECTUS_ADMIN_EMAIL:-admin@fiutami.pet}
      - ADMIN_PASSWORD=${DIRECTUS_ADMIN_PASSWORD:-}
      - PUBLIC_URL=https://bo.stage.fiutami.pet
    depends_on:
      db:
        condition: service_healthy
    networks:
      - fiutami-stage
      - proxy-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8055/server/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  fiutami-stage:
    driver: bridge
  proxy-net:
    external: true

volumes:
  mssql-stage-data:
